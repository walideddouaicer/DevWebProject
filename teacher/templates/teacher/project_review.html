{% extends 'teacher/base.html' %}
{% load static %}

{% block title %}{{ project.title }} - √âvaluation Projet{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'student/css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'teacher/css/teacher.css' %}">
<style>
.teacher-project-header {
    background: linear-gradient(135deg, #2c5aa0 0%, #1e3d72 100%);
    color: white;
    padding: 25px;
    border-radius: 8px;
    margin-bottom: 30px;
}

.teacher-project-header h1 {
    margin: 0 0 15px 0;
    color: white;
}

.project-meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.project-meta-item {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 4px;
}

.teacher-actions {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    border-left: 4px solid #2c5aa0;
}

.teacher-actions h3 {
    margin: 0 0 15px 0;
    color: #2c5aa0;
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.teacher-comment-form {
    background: white;
    border: 2px solid #2c5aa0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
}

.teacher-comment-form h3 {
    color: #2c5aa0;
    margin: 0 0 15px 0;
}

.detail-section {
    margin-bottom: 30px;
}

.deliverables-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.deliverable-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.milestones-timeline {
    margin-top: 15px;
}

.milestone-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 4px;
}

.milestone-status {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.milestone-completed {
    background: #28a745;
    color: white;
}

.milestone-pending {
    background: #6c757d;
    color: white;
}

.milestone-overdue {
    background: #dc3545;
    color: white;
}

.teacher-comment {
    background: #e8f4ff;
    border-left: 4px solid #2c5aa0;
}

.student-comment {
    background: #f8f9fa;
    border-left: 4px solid #6c757d;
}

.comment-item {
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.comment-author {
    font-weight: bold;
    color: #2c5aa0;
}

.comment-date {
    font-size: 0.9em;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
    <!-- Project Header -->
    <div class="teacher-project-header">
        <h1>{{ project.title }}</h1>
        <div class="project-meta-grid">
            <div class="project-meta-item">
                <strong>√âtudiant:</strong> {{ project.student.user.get_full_name|default:project.student.user.username }}
            </div>
            <div class="project-meta-item">
                <strong>Module:</strong> {% if project.module %}{{ project.module.code }} - {{ project.module.name }}{% else %}Non assign√©{% endif %}
            </div>
            <div class="project-meta-item">
                <strong>Type:</strong> {{ project.get_project_type_display }}
            </div>
            <div class="project-meta-item">
                <strong>Statut:</strong> 
                <span class="status-badge status-{{ project.status|lower }}">
                    {{ project.get_status_display }}
                </span>
            </div>
            <div class="project-meta-item">
                <strong>Cr√©√© le:</strong> {{ project.created_at|date:"d/m/Y" }}
            </div>
            <div class="project-meta-item">
                <strong>Derni√®re mise √† jour:</strong> {{ project.updated_at|date:"d/m/Y H:i" }}
            </div>
        </div>
    </div>

    <!-- Teacher Actions -->
    {% if project.status == 'submitted' %}
    <div class="teacher-actions">
        <h3>Actions Enseignant</h3>
        <p>Ce projet est soumis et attend votre √©valuation.</p>
        <div class="action-buttons">
            <form method="post" action="{% url 'teacher:approve_project' project.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn" style="background: #28a745; color: white;" 
                        onclick="return confirm('√ätes-vous s√ªr de vouloir valider ce projet?')">
                    ‚úì Valider le Projet
                </button>
            </form>
            <form method="post" action="{% url 'teacher:reject_project' project.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger" 
                        onclick="return confirm('√ätes-vous s√ªr de vouloir rejeter ce projet?')">
                    ‚úó Rejeter le Projet
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Teacher Comment Form -->
    <div class="teacher-comment-form">
        <h3>Ajouter un Commentaire / Feedback</h3>
        <form method="post" action="{% url 'teacher:add_teacher_comment' project.id %}">
            {% csrf_token %}
            <div class="form-group">
                <textarea name="content" rows="4" placeholder="Ajoutez votre commentaire ou feedback ici..." 
                          style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required></textarea>
            </div>
            <button type="submit" class="btn" style="background: #2c5aa0; color: white;">
                üí¨ Ajouter Commentaire
            </button>
        </form>
    </div>

    <!-- Project Description -->
    <div class="detail-section">
        <div class="card">
            <h2>Description du Projet</h2>
            <p>{{ project.description|linebreaks }}</p>
            
            {% if project.technologies %}
            <div style="margin-top: 15px;">
                <strong>Technologies utilis√©es:</strong> {{ project.technologies }}
            </div>
            {% endif %}
            
            {% if project.module_or_company %}
            <div style="margin-top: 10px;">
                <strong>Module/Entreprise:</strong> {{ project.module_or_company }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Collaborators -->
    {% if project.collaborators.exists %}
    <div class="detail-section">
        <div class="card">
            <h2>Collaborateurs ({{ project.collaborators.count }})</h2>
            <ul style="list-style: none; padding: 0;">
                {% for collaborator in project.collaborators.all %}
                <li style="padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                    <strong>{{ collaborator.user.get_full_name|default:collaborator.user.username }}</strong>
                    <span style="color: #6c757d;">({{ collaborator.student_id }}) - {{ collaborator.department }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Deliverables -->
    <div class="detail-section">
        <div class="card">
            <h2>Livrables ({{ deliverables.count }})</h2>
            {% if deliverables %}
                <div class="deliverables-grid">
                    {% for deliverable in deliverables %}
                    <div class="deliverable-card">
                        <h4>{{ deliverable.name }}</h4>
                        <p><strong>Type:</strong> {{ deliverable.get_file_type_display }}</p>
                        <p><strong>Upload√© le:</strong> {{ deliverable.upload_date|date:"d/m/Y H:i" }}</p>
                        <a href="{{ deliverable.file.url }}" class="btn btn-sm" target="_blank">üì• T√©l√©charger</a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-state">Aucun livrable disponible.</p>
            {% endif %}
        </div>
    </div>

    <!-- Milestones -->
    <div class="detail-section">
        <div class="card">
            <h2>Jalons ({{ milestones.count }})</h2>
            {% if milestones %}
                <div class="milestones-timeline">
                    {% for milestone in milestones %}
                    <div class="milestone-item">
                        <div class="milestone-status 
                            {% if milestone.completed %}milestone-completed
                            {% elif milestone.is_overdue %}milestone-overdue
                            {% else %}milestone-pending{% endif %}">
                            {% if milestone.completed %}‚úì{% else %}‚Ä¢{% endif %}
                        </div>
                        <div style="flex: 1;">
                            <strong>{{ milestone.title }}</strong>
                            <div style="color: #6c757d; font-size: 0.9em;">
                                √âch√©ance: {{ milestone.due_date|date:"d/m/Y" }}
                                {% if milestone.completed %}
                                    ‚Ä¢ Compl√©t√© le {{ milestone.completed_at|date:"d/m/Y" }}
                                {% elif milestone.is_overdue %}
                                    ‚Ä¢ En retard
                                {% endif %}
                            </div>
                            {% if milestone.description %}
                            <p style="margin: 5px 0 0 0; font-size: 0.9em;">{{ milestone.description }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-state">Aucun jalon d√©fini.</p>
            {% endif %}
        </div>
    </div>

    <!-- Comments and Discussion -->
    <div class="detail-section">
        <div class="card">
            <h2>Discussion et Commentaires</h2>
            {% if comments %}
                {% for comment in comments %}
                <div class="comment-item {% if '[FEEDBACK ENSEIGNANT]' in comment.content %}teacher-comment{% else %}student-comment{% endif %}">
                    <div class="comment-header">
                        <span class="comment-author">
                            {{ comment.author.user.get_full_name|default:comment.author.user.username }}
                            {% if '[FEEDBACK ENSEIGNANT]' in comment.content %}
                                (Enseignant)
                            {% else %}
                                (√âtudiant)
                            {% endif %}
                        </span>
                        <span class="comment-date">{{ comment.created_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    <div class="comment-content">
                        {{ comment.content|linebreaks }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="empty-state">Aucun commentaire pour le moment.</p>
            {% endif %}
        </div>
    </div>

    <!-- Navigation -->
    <div style="text-align: center; margin-top: 30px;">
        <a href="{% url 'teacher:student_projects' %}" class="btn btn-secondary">‚Üê Retour √† la liste des projets</a>
    </div>
{% endblock %}