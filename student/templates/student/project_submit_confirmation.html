{% extends 'student/base.html' %}
{% load static %}

{% block title %}Confirmer la Soumission - {{ project.title }}{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">></span>
<a href="{% url 'student:dashboard' %}" class="breadcrumb-link">Projets</a>
<span class="breadcrumb-separator">></span>
<a href="{% url 'student:project_detail' project.id %}" class="breadcrumb-link">{{ project.title|truncatewords:3 }}</a>

<span class="breadcrumb-separator">></span>
<span>Confirmation</span>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'student/css/project_submit_confirmation.css' %}">

{% endblock %}

{% block content %}
<div class="confirmation-container">
    <!-- Hero Section -->
    <div class="confirmation-hero">
        <div class="hero-content">
            <div class="warning-icon">⚠️</div>
            <h1 class="hero-title">Confirmer la Soumission</h1>
            <p class="hero-subtitle">
                Vous êtes sur le point de soumettre votre projet pour évaluation
            </p>
        </div>
    </div>

    <div class="confirmation-workspace">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Project Information -->
            <div class="confirmation-card project-info-card">
                <div class="card-header">
                    <div class="card-icon" style="background: var(--info-gradient);">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h2 class="card-title">Informations du Projet</h2>
                </div>
                
                <div class="project-info-grid">
                    <span class="info-label">Titre:</span>
                    <span class="info-value">{{ project.title }}</span>
                    
                    <span class="info-label">Type:</span>
                    <span class="info-value">{{ project.get_project_type_display }}</span>
                    
                    <span class="info-label">Propriétaire:</span>
                    <span class="info-value">{{ project.student.user.get_full_name|default:project.student.user.username }}</span>
                    
                    <span class="info-label">Collaborateurs:</span>
                    <span class="info-value">
                        {% if project.collaborators.exists %}
                            {{ project.collaborators.count }} collaborateur{{ project.collaborators.count|pluralize }}
                        {% else %}
                            Aucun collaborateur
                        {% endif %}
                    </span>
                    
                    <span class="info-label">Dernière modification:</span>
                    <span class="info-value">{{ project.updated_at|date:"d/m/Y à H:i" }}</span>
                </div>
            </div>

            <!-- Critical Warnings -->
            <div class="confirmation-card warning-card">
                <div class="card-header">
                    <div class="card-icon" style="background: var(--error-gradient);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 class="card-title">Actions Irréversibles</h2>
                </div>
                
                <div class="warning-list">
                    <div class="warning-item">
                        <div class="warning-item-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="warning-item-content">
                            <strong>Modification impossible</strong>
                            Une fois soumis, vous ne pourrez plus modifier le projet, ajouter de collaborateurs, ni télécharger de nouveaux livrables.
                        </div>
                    </div>
                    
                    <div class="warning-item">
                        <div class="warning-item-icon">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="warning-item-content">
                            <strong>Invitations en attente</strong>
                            Vous devrez annuler toutes les invitations en attente manuellement avant la soumission du projet pour éviter qu'un autre élève puisse rejoindre après la soumission du projet.
                        </div>
                    </div>
                    
                    <div class="warning-item">
                        <div class="warning-item-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="warning-item-content">
                            <strong>Évaluation finale</strong>
                            Votre projet sera évalué dans son état actuel. Assurez-vous qu'il est complet.
                        </div>
                    </div>
                    
                    <div class="warning-item">
                        <div class="warning-item-icon">
                            <i class="fas fa-redo"></i>
                        </div>
                        <div class="warning-item-content">
                            <strong>Seul retour possible</strong>
                            Si le projet est rejeté, vous pourrez le modifier et le resoumettre.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pre-submission Checklist -->
            <div class="confirmation-card checklist-card">
                <div class="card-header">
                    <div class="card-icon" style="background: var(--success-gradient);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 class="card-title">Liste de Vérification Pré-Soumission</h2>
                </div>
                
                <div class="checklist-items">
                    <!-- Deliverables Check -->
                    <div class="checklist-item">
                        <div class="status-indicator {% if deliverables_count > 0 %}status-ok{% else %}status-warning{% endif %}">
                            {% if deliverables_count > 0 %}
                                <i class="fas fa-check"></i>
                            {% else %}
                                <i class="fas fa-exclamation"></i>
                            {% endif %}
                        </div>
                        <div class="checklist-content">
                            <div class="checklist-title">Livrables</div>
                            <p class="checklist-description {% if deliverables_count > 0 %}success{% else %}warning{% endif %}">
                                {% if deliverables_count > 0 %}
                                    {{ deliverables_count }} livrable{{ deliverables_count|pluralize }} téléchargé{{ deliverables_count|pluralize }}
                                {% else %}
                                    Aucun livrable téléchargé
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Milestones Check -->
                    <div class="checklist-item">
                        <div class="status-indicator {% if milestones_count > 0 %}status-ok{% else %}status-warning{% endif %}">
                            {% if milestones_count > 0 %}
                                <i class="fas fa-check"></i>
                            {% else %}
                                <i class="fas fa-exclamation"></i>
                            {% endif %}
                        </div>
                        <div class="checklist-content">
                            <div class="checklist-title">Jalons</div>
                            <p class="checklist-description {% if milestones_count > 0 %}success{% else %}warning{% endif %}">
                                {% if milestones_count > 0 %}
                                    {{ milestones_count }} jalon{{ milestones_count|pluralize }} défini{{ milestones_count|pluralize }}
                                    ({{ completed_milestones_count }} complété{{ completed_milestones_count|pluralize }})
                                {% else %}
                                    Aucun jalon défini
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Pending Invitations Check -->
                    <div class="checklist-item">
                        {% with pending_count=pending_invitations.count %}
                        <div class="status-indicator {% if pending_count == 0 %}status-ok{% else %}status-error{% endif %}">
                            {% if pending_count == 0 %}
                                <i class="fas fa-check"></i>
                            {% else %}
                                <i class="fas fa-times"></i>
                            {% endif %}
                        </div>
                        <div class="checklist-content">
                            <div class="checklist-title">Invitations en attente</div>
                            <p class="checklist-description {% if pending_count == 0 %}success{% else %}error{% endif %}">
                                {% if pending_count == 0 %}
                                    Aucune invitation en attente
                                {% else %}
                                    {{ pending_count }} invitation{{ pending_count|pluralize }} en attente - Ces invitations devront etre manuellement annulées !
                                {% endif %}
                            </p>
                            {% if pending_count > 0 %}
                                <div class="pending-invitations">
                                    {% for invitation in pending_invitations %}
                                        <div class="invitation-item">
                                            <i class="fas fa-user-clock"></i>
                                            <span>{{ invitation.recipient.user.get_full_name|default:invitation.recipient.user.username }}</span>
                                            <span>(envoyée {{ invitation.created_at|timesince }})</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endwith %}
                    </div>
                    
                    <!-- Project Completeness -->
                    <div class="checklist-item">
                        <div class="status-indicator {% if project.description and project.technologies %}status-ok{% else %}status-warning{% endif %}">
                            {% if project.description and project.technologies %}
                                <i class="fas fa-check"></i>
                            {% else %}
                                <i class="fas fa-exclamation"></i>
                            {% endif %}
                        </div>
                        <div class="checklist-content">
                            <div class="checklist-title">Informations du projet</div>
                            <p class="checklist-description {% if project.description and project.technologies %}success{% else %}warning{% endif %}">
                                {% if project.description and project.technologies %}
                                    Description et technologies renseignées
                                {% else %}
                                    {% if not project.description %}Description manquante{% endif %}
                                    {% if not project.description and not project.technologies %} et {% endif %}
                                    {% if not project.technologies %}Technologies manquantes{% endif %}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Final Warning -->
            <div class="final-warning">
                <div class="final-warning-content">
                    <div class="final-warning-title">
                        🚨 DERNIÈRE CHANCE 🚨
                    </div>
                    <div class="final-warning-text">
                        Une fois confirmé, votre projet sera définitivement soumis pour évaluation.<br>
                        Vous ne pourrez plus le modifier jusqu'à la décision de l'enseignant.
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="submission-actions">
                <div class="action-buttons">
                    <a href="{% url 'student:project_detail' project.id %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left"></i>
                        Retour au Projet
                    </a>
                    
                    <form method="post" action="{% url 'student:project_submit' project.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-lg" 
                                onclick="return confirm('🚨 CONFIRMATION FINALE 🚨\n\nÊtes-vous absolument certain(e) de vouloir soumettre ce projet ?\n\n⚠️ Cette action est IRRÉVERSIBLE ⚠️\n\n✅ Cliquez OK pour confirmer la soumission\n❌ Cliquez Annuler pour retourner au projet')">
                            <i class="fas fa-rocket"></i>
                            Confirmer la Soumission
                        </button>
                    </form>
                </div>
                
                <div class="action-advice">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Conseil:</strong> Si vous avez des doutes, retournez au projet pour effectuer les dernières vérifications.
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar-content">
            <!-- Submission Impact -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <div class="sidebar-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    Impact de la Soumission
                </h3>
                
                <div class="impact-list">
                    <div class="impact-item">
                        <div class="impact-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <p class="impact-text">
                            <strong>Verrouillage complet:</strong> Aucune modification ne sera possible après soumission.
                        </p>
                    </div>
                    
                    <div class="impact-item">
                        <div class="impact-icon">
                            <i class="fas fa-user-slash"></i>
                        </div>
                        <p class="impact-text">
                            <strong>Fin des collaborations:</strong> Plus d'ajout de collaborateurs possible.
                        </p>
                    </div>
                    
                    <div class="impact-item">
                        <div class="impact-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <p class="impact-text">
                            <strong>Arrêt des uploads:</strong> Impossible d'ajouter de nouveaux livrables.
                        </p>
                    </div>
                    
                    <div class="impact-item">
                        <div class="impact-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <p class="impact-text">
                            <strong>Évaluation professeur:</strong> Votre projet sera évalué par l'enseignant.
                        </p>
                    </div>
                </div>
            </div>

            <!-- What Happens Next -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <div class="sidebar-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    Que se passe-t-il ensuite ?
                </h3>
                
                <div class="timeline-item">
                    <div class="timeline-number">1</div>
                    <p class="timeline-text">Votre projet sera immédiatement verrouillé</p>
                </div>
                
                <div class="timeline-item">
                    <div class="timeline-number">2</div>
                    <p class="timeline-text">L'enseignant recevra une notification</p>
                </div>
                
                <div class="timeline-item">
                    <div class="timeline-number">3</div>
                    <p class="timeline-text">Évaluation et feedback du professeur</p>
                </div>
                
                <div class="timeline-item">
                    <div class="timeline-number">4</div>
                    <p class="timeline-text">Validation finale ou demandes de modifications</p>
                </div>
            </div>

            <!-- Last Checks -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <div class="sidebar-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    Dernières Vérifications
                </h3>
                
                <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
                    <p style="margin-bottom: var(--space-4);">
                        <strong style="color: var(--text-primary);">✅ Livrables:</strong> 
                        Tous vos documents essentiels sont-ils uploadés ?
                    </p>
                    <p style="margin-bottom: var(--space-4);">
                        <strong style="color: var(--text-primary);">✅ Description:</strong> 
                        Votre description est-elle complète et claire ?
                    </p>
                    <p style="margin-bottom: var(--space-4);">
                        <strong style="color: var(--text-primary);">✅ Technologies:</strong> 
                        Avez-vous listé toutes les technologies utilisées ?
                    </p>
                    <p style="margin: 0;">
                        <strong style="color: var(--text-primary);">✅ Équipe:</strong> 
                        Tous vos collaborateurs sont-ils bien ajoutés ?
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add confirmation animation effects
    initializeConfirmationEffects();
    
    function initializeConfirmationEffects() {
        // Animate cards on scroll
        const cards = document.querySelectorAll('.confirmation-card, .sidebar-card');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry, index) => {
                if (entry.isIntersecting) {
                    setTimeout(() => {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }, index * 100);
                }
            });
        }, { threshold: 0.1 });
        
        cards.forEach(card => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.6s ease';
            observer.observe(card);
        });
        
        // Add pulsing effect to critical elements
        const warningElements = document.querySelectorAll('.status-error, .final-warning');
        warningElements.forEach(element => {
            element.addEventListener('mouseenter', function() {
                this.style.animation = 'pulse 1s ease-in-out';
            });
            
            element.addEventListener('animationend', function() {
                this.style.animation = '';
            });
        });
        
        // Enhanced submit button confirmation
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.addEventListener('click', function(e) {
                // Add visual feedback
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            });
        }
    }
    
    // Show toast for pending invitations
    const pendingInvitations = document.querySelector('.pending-invitations');
    if (pendingInvitations) {
        if (window.appUtils && window.appUtils.showToast) {
            window.appUtils.showToast(
                'Attention: Des invitations sont en attente et deront etre manuellement annulées !',
                'warning',
                5000
            );
        }
    }
});
</script>
{% endblock %}