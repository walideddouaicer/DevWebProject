{% extends "student/base.html" %}
{% load static %}

{% block title %}Supprimer le Projet - ENSA Project Manager{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">></span>
<a href="{% url 'student:dashboard' %}" class="breadcrumb-link">Projets</a>
<span class="breadcrumb-separator">></span>
<a href="{% url 'student:project_detail' project.id %}" class="breadcrumb-link">{{ project.title|truncatewords:3 }}</a>
<span class="breadcrumb-separator">></span>
<span>Supprimer</span>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'student/css/project_delete_confirm.css' %}">

{% endblock %}

{% block content %}
    <div class="delete-workspace">
        <!-- Warning Hero -->
        <div class="warning-hero">
            <div class="warning-content">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h1 class="warning-title">Supprimer le Projet</h1>
                <p class="warning-subtitle">Cette action est d√©finitive et ne peut pas √™tre annul√©e</p>
            </div>
        </div>

        <!-- Confirmation Container -->
        <div class="confirmation-container">
            <div class="confirmation-header">
                <h2>üö® √ätes-vous absolument certain?</h2>
                <p>
                    Vous √™tes sur le point de supprimer d√©finitivement le projet suivant et toutes ses donn√©es associ√©es. 
                    Cette action est irr√©versible et aura des cons√©quences importantes.
                </p>
            </div>

            <!-- Project Summary -->
            <div class="project-summary">
                <h3 class="summary-title">
                    üìä R√©capitulatif du Projet
                </h3>
                <div class="summary-grid">
                    <span class="summary-label">üìù Nom du projet:</span>
                    <span class="summary-value"><strong>{{ project.title }}</strong></span>
                    
                    <span class="summary-label">üìÇ Type:</span>
                    <span class="summary-value">{{ project.get_project_type_display }}</span>
                    
                    <span class="summary-label">üìÖ Cr√©√© le:</span>
                    <span class="summary-value">{{ project.created_at|date:"d/m/Y √† H:i" }}</span>
                    
                    <span class="summary-label">üìä Statut actuel:</span>
                    <span class="summary-value">{{ project.get_status_display }}</span>
                    
                    {% if project.module %}
                    <span class="summary-label">üìö Module associ√©:</span>
                    <span class="summary-value">{{ project.module.code }} - {{ project.module.name }}</span>
                    {% endif %}
                    
                    {% if project.collaborators.count > 0 %}
                    <span class="summary-label">üë• Collaborateurs:</span>
                    <span class="summary-value">{{ project.collaborators.count }} collaborateur{{ project.collaborators.count|pluralize }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Collaborators Warning -->
            {% if project.collaborators.count > 0 %}
            <div class="collaborators-warning">
                <h4 class="warning-title-small">
                    üë• Attention: Collaborateurs Actifs
                </h4>
                <p style="margin: 0; color: var(--warning); font-size: var(--text-sm); line-height: 1.6;">
                    Ce projet a <strong>{{ project.collaborators.count }} collaborateur{{ project.collaborators.count|pluralize }}</strong>. 
                    La suppression les privera √©galement d'acc√®s √† ce projet et √† tout son contenu, 
                    y compris leurs contributions et leur historique de travail.
                </p>
            </div>
            {% endif %}

            <!-- Consequences List -->
            <div class="consequences-section">
                <h3 class="consequences-title">
                    ‚ö†Ô∏è Cons√©quences de la Suppression
                </h3>
                <ul class="consequences-list">
                    <li class="consequence-item">
                        <div class="consequence-number">1</div>
                        <div class="consequence-content">
                            <strong>Perte de donn√©es d√©finitive:</strong> Le projet et toutes ses informations 
                            (description, technologies, dates) seront supprim√©s de fa√ßon permanente et irr√©versible.
                        </div>
                    </li>
                    
                    <li class="consequence-item">
                        <div class="consequence-number">2</div>
                        <div class="consequence-content">
                            <strong>Suppression des livrables:</strong> Tous les fichiers upload√©s (documents, rapports, 
                            pr√©sentations, code source) seront d√©finitivement effac√©s du syst√®me.
                        </div>
                    </li>
                    
                    <li class="consequence-item">
                        <div class="consequence-number">3</div>
                        <div class="consequence-content">
                            <strong>Perte de l'historique:</strong> Tous les jalons, commentaires, discussions et 
                            l'historique complet des activit√©s seront perdus sans possibilit√© de r√©cup√©ration.
                        </div>
                    </li>
                    
                    <li class="consequence-item">
                        <div class="consequence-number">4</div>
                        <div class="consequence-content">
                            <strong>Impact sur les collaborateurs:</strong> Les collaborateurs perdront imm√©diatement 
                            l'acc√®s au projet, √† tous ses contenus et √† leur historique de contributions.
                        </div>
                    </li>
                    
                    <li class="consequence-item">
                        <div class="consequence-number">5</div>
                        <div class="consequence-content">
                            <strong>Aucune r√©cup√©ration possible:</strong> Il sera techniquement impossible de 
                            restaurer le projet, ses donn√©es ou son contenu apr√®s confirmation de la suppression.
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Safety Section -->
            <div class="safety-section">
                <h4 class="safety-title">
                    üîí Mesure de S√©curit√© Obligatoire
                </h4>
                <p style="margin: 0 0 var(--space-3) 0; color: var(--accent-primary); font-size: var(--text-sm); line-height: 1.6;">
                    Pour confirmer cette action critique, vous devez taper <strong>exactement</strong> le nom du projet 
                    dans le champ ci-dessous. Cette mesure de s√©curit√© √©vite les suppressions accidentelles.
                </p>
                
                <div class="project-name-display">
                    {{ project.title }}
                </div>
            </div>

            <!-- Confirmation Form -->
            <form method="post" id="deleteForm">
                {% csrf_token %}
                <div class="confirmation-form">
                    <label for="confirmInput" class="form-label">
                        ‚ö†Ô∏è Tapez le nom exact du projet pour confirmer:
                    </label>
                    <input type="text" id="confirmInput" class="confirm-input" 
                           placeholder="Tapez exactement: {{ project.title }}" 
                           autocomplete="off" required>
                    <div class="typing-feedback" id="typingFeedback">
                        Tapez le nom exact du projet...
                    </div>
                </div>
                
                <div class="final-warning">
                    üö® <strong>DERNI√àRE CONFIRMATION</strong> üö®<br>
                    Une fois valid√©, votre projet sera d√©finitivement supprim√©.<br>
                    Cette action est <strong>IRR√âVERSIBLE</strong>.
                </div>
                
                <div class="form-actions">
                    <a href="{% url 'student:project_detail' project.id %}" class="btn-cancel">
                        üîô Retourner au Projet
                    </a>
                    <button type="submit" class="btn-delete" id="deleteButton" disabled>
                        üóëÔ∏è Supprimer D√©finitivement
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const confirmInput = document.getElementById('confirmInput');
            const deleteButton = document.getElementById('deleteButton');
            const typingFeedback = document.getElementById('typingFeedback');
            const projectTitle = "{{ project.title }}";
            
            // Input validation
            confirmInput.addEventListener('input', function() {
                const inputValue = this.value.trim();
                typingFeedback.classList.add('show');
                
                if (inputValue === projectTitle) {
                    deleteButton.disabled = false;
                    deleteButton.style.opacity = '1';
                    typingFeedback.textContent = '‚úÖ Nom correct. Vous pouvez maintenant supprimer le projet.';
                    typingFeedback.className = 'typing-feedback show success';
                } else if (inputValue.length > 0) {
                    deleteButton.disabled = true;
                    deleteButton.style.opacity = '0.6';
                    
                    // Show progress
                    const similarity = calculateSimilarity(inputValue, projectTitle);
                    if (similarity > 0.7) {
                        typingFeedback.textContent = 'üî∂ Presque correct. V√©rifiez l\'orthographe et la casse.';
                        typingFeedback.className = 'typing-feedback show';
                    } else {
                        typingFeedback.textContent = '‚ùå Le nom ne correspond pas. V√©rifiez l\'orthographe exacte.';
                        typingFeedback.className = 'typing-feedback show error';
                    }
                } else {
                    deleteButton.disabled = true;
                    deleteButton.style.opacity = '0.6';
                    typingFeedback.textContent = 'Tapez le nom exact du projet...';
                    typingFeedback.className = 'typing-feedback show';
                }
            });
            
            // Calculate string similarity (simple version)
            function calculateSimilarity(str1, str2) {
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;
                
                if (longer.length === 0) return 1.0;
                
                const editDistance = levenshteinDistance(longer, shorter);
                return (longer.length - editDistance) / longer.length;
            }
            
            function levenshteinDistance(str1, str2) {
                const matrix = [];
                
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }
            
            // Final confirmation before submission
            document.getElementById('deleteForm').addEventListener('submit', function(e) {
                const confirmed = confirm(
                    'üö® CONFIRMATION FINALE üö®\n\n' +
                    '√ätes-vous absolument certain de vouloir supprimer ce projet ?\n\n' +
                    '‚ö†Ô∏è Cette action est IRR√âVERSIBLE ‚ö†Ô∏è\n\n' +
                    '‚Ä¢ Toutes les donn√©es seront perdues\n' +
                    '‚Ä¢ Les collaborateurs perdront l\'acc√®s\n' +
                    '‚Ä¢ Aucune r√©cup√©ration possible\n\n' +
                    '‚úÖ Cliquez OK pour confirmer la suppression\n' +
                    '‚ùå Cliquez Annuler pour retourner au projet'
                );
                
                if (!confirmed) {
                    e.preventDefault();
                } else {
                    // Show loading state
                    deleteButton.textContent = '‚è≥ Suppression en cours...';
                    deleteButton.disabled = true;
                }
            });
            
            // Auto-focus on the input
            confirmInput.focus();
            
            // Prevent accidental page refresh
            window.addEventListener('beforeunload', function(e) {
                if (confirmInput.value.trim() !== '') {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>
{% endblock %}