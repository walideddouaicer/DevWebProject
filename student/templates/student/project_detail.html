{% extends 'student/base.html' %}
{% load static %}

{% block title %}{{ project.title }} - D√©tails du Projet{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">></span>
<a href="{% url 'student:dashboard' %}">Projets</a>
<span class="breadcrumb-separator">></span>
<span>{{ project.title|truncatewords:3 }}</span>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'student/css/project_detail.css' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    <!-- Project Hero Section -->
    <div class="project-hero">
        <div class="project-header-content">
            <div class="project-title-section">
                <h1>{{ project.title }}</h1>
                <div class="project-badges">
                    <span class="status-badge status-{{ project.status|lower }}">
                        {{ project.get_status_display }}
                    </span>
                    {% if project.module %}
                    <span class="hero-badge">
                        üìö {{ project.module.code }}
                    </span>
                    {% endif %}
                    {% if is_owner %}
                    <span class="hero-badge">
                        üëë Propri√©taire
                    </span>
                    {% elif is_collaborator %}
                    <span class="hero-badge">
                        ü§ù Collaborateur
                    </span>
                    {% endif %}
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Progression du Projet</span>
                        <span class="progress-percentage">
                            {% if project.status == 'draft' %}25%
                            {% elif project.status == 'in_progress' %}50%
                            {% elif project.status == 'submitted' %}75%
                            {% elif project.status == 'validated' %}100%
                            {% elif project.status == 'rejected' %}25%
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar progress-{{ project.status|lower }}"></div>
                    </div>
                </div>
                
                <div class="project-meta-grid">
                    <div class="meta-card">
                        <div class="meta-label">üë§ Propri√©taire</div>
                        <div class="meta-value">{{ project.student.user.get_full_name|default:project.student.user.username }}</div>
                    </div>
                    <div class="meta-card">
                        <div class="meta-label">üìÇ Type de Projet</div>
                        <div class="meta-value">{{ project.get_project_type_display }}</div>
                    </div>
                    <div class="meta-card">
                        <div class="meta-label">üìÖ Date de Cr√©ation</div>
                        <div class="meta-value">{{ project.created_at|date:"d/m/Y" }}</div>
                    </div>
                    <div class="meta-card">
                        <div class="meta-label">‚è∞ Derni√®re MAJ</div>
                        <div class="meta-value">{{ project.updated_at|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
            </div>
            <div class="hero-illustration">üìä</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="project-workspace">
        <div>
            <!-- Actions Panel -->
            <div class="actions-panel">
                <div class="actions-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: var(--text-xl); font-weight: 700;">‚ö° Actions Disponibles</h3>
                        <span style="font-size: var(--text-sm); color: var(--text-muted);">G√©rez votre projet</span>
                    </div>
                </div>
                <div class="actions-grid">
                    {% if project.status == 'in_progress' %}
                        {% if is_owner %}
                            <a href="{% url 'student:project_edit' project.id %}" class="action-btn primary">
                                ‚úèÔ∏è Modifier le Projet
                            </a>
                            <a href="{% url 'student:project_delete' project.id %}" class="action-btn danger">
                                üóëÔ∏è Supprimer le Projet
                            </a>
                            
                            <!-- UPDATED: Changed from direct form submission to confirmation page -->
                            <a href="{% url 'student:project_submit_confirmation' project.id %}" class="action-btn success">
                                üöÄ Soumettre pour Validation
                            </a>
                        {% endif %}
                        
                        <!-- Other actions for collaborators -->
                        <a href="{% url 'student:add_milestone' project.id %}" class="action-btn primary">
                            üìÖ Ajouter un Jalon
                        </a>
                        <a href="{% url 'student:upload_deliverable' project.id %}" class="action-btn primary">
                            üìé Ajouter un Livrable
                        </a>
                        
                    {% elif project.status == 'submitted' %}
                        <!-- Your existing submitted message code -->
                        <div class="status-message submitted">
                            <div class="status-icon">üìã</div>
                            <div class="status-content">
                                <h4>Projet Soumis pour Validation</h4>
                                <p>Votre projet a √©t√© soumis et est en attente d'√©valuation par l'enseignant. Aucune modification n'est possible pour le moment.</p>
                                {% if is_owner %}
                                    <small style="color: var(--text-muted);">
                                        üí° <strong>Astuce:</strong> Si votre projet est rejet√©, vous pourrez le modifier et le resoumettre.
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                        
                    {% elif project.status == 'validated' %}
                        <!-- Your existing validated message code -->
                        <div class="status-message validated">
                            <div class="status-icon">‚úÖ</div>
                            <div class="status-content">
                                <h4>Projet Valid√©</h4>
                                <p>F√©licitations ! Votre projet a √©t√© valid√© par l'enseignant. Aucune action suppl√©mentaire n'est requise.</p>
                            </div>
                        </div>
                        
                    {% elif project.status == 'rejected' %}
                        <!-- Your existing rejected message code -->
                        <div class="status-message rejected">
                            <div class="status-icon">‚ùå</div>
                            <div class="status-content">
                                <h4>Projet Rejet√©</h4>
                                <p>Votre projet a √©t√© rejet√©. Consultez les commentaires de l'enseignant ci-dessous pour les am√©liorations √† apporter.</p>
                            </div>
                        </div>
                        
                        {% if is_owner %}
                            <a href="{% url 'student:project_edit' project.id %}" class="action-btn primary">
                                ‚úèÔ∏è Modifier le Projet
                            </a>
                            <form method="post" action="{% url 'student:project_change_status' project.id 'in_progress' %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="action-btn warning">
                                    üîÑ Reprendre les Modifications
                                </button>
                            </form>
                        {% endif %}
                        
                    {% else %}
                        <!-- Fallback message -->
                        <div class="status-message default">
                            <div class="status-icon">‚ÑπÔ∏è</div>
                            <div class="status-content">
                                <h4>Aucune Action Disponible</h4>
                                <p>Aucune action n'est actuellement disponible pour ce projet.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Project Description -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">üìù Description du Projet</h2>
                </div>
                <div class="section-body">
                    <div style="line-height: 1.6; color: var(--text-secondary);">
                        {{ project.description|linebreaks }}
                    </div>
                    
                    {% if project.module_or_company %}
                    <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-primary);">
                        <strong style="color: var(--accent-primary);">üè¢ Module/Entreprise:</strong> {{ project.module_or_company }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Collaborators -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">üë• √âquipe de Projet</h2>
                    <span style="font-size: var(--text-sm); color: var(--text-muted);">{{ collaborators.count|add:1 }} membre{{ collaborators.count|add:1|pluralize }}</span>
                </div>
                <div class="section-body">
                    <!-- Project Owner -->
                    <div style="margin-bottom: var(--space-6);">
                        <h4 style="color: var(--accent-primary); margin-bottom: var(--space-3); font-size: var(--text-lg);">üëë Propri√©taire du Projet</h4>
                        <div class="collaborator-card" style="border-left: 4px solid #f59e0b;">
                            <div class="collaborator-avatar" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                {{ project.student.user.first_name|first|default:project.student.user.username|first|upper }}
                            </div>
                            <div style="flex: 1;">
                                <strong style="color: var(--text-primary);">{{ project.student.user.get_full_name|default:project.student.user.username }}</strong><br>
                                <small style="color: var(--text-muted);">{{ project.student.student_id }} ‚Ä¢ {{ project.student.department }}</small>
                            </div>
                            <div style="background: #f59e0b; color: white; padding: var(--space-1) var(--space-3); border-radius: var(--radius-md); font-size: var(--text-xs); font-weight: 600;">
                                PROPRI√âTAIRE
                            </div>
                        </div>
                    </div>

                    <!-- Collaborators -->
                    {% if collaborators %}
                    <div style="margin-bottom: var(--space-6);">
                        <h4 style="color: var(--accent-primary); margin-bottom: var(--space-3); font-size: var(--text-lg);">ü§ù Collaborateurs ({{ collaborators.count }})</h4>
                        <div class="collaborators-grid">
                            {% for collaborator in collaborators %}
                            <div class="collaborator-card">
                                <div class="collaborator-avatar">
                                    {{ collaborator.user.first_name|first|default:collaborator.user.username|first|upper }}
                                </div>
                                <div style="flex: 1;">
                                    <strong style="color: var(--text-primary);">{{ collaborator.user.get_full_name|default:collaborator.user.username }}</strong><br>
                                    <small style="color: var(--text-muted);">{{ collaborator.student_id }} ‚Ä¢ {{ collaborator.department }}</small>
                                </div>
                                {% if is_owner and project.status == 'in_progress' %}
                                <a href="{% url 'student:remove_collaborator' project.id collaborator.id %}" 
                                   class="action-btn danger" style="padding: var(--space-1) var(--space-2); font-size: var(--text-xs);"
                                   onclick="return confirm('Retirer {{ collaborator.user.get_full_name|default:collaborator.user.username }} du projet?')">
                                    üóëÔ∏è
                                </a>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Add Collaborators (Owner Only) -->
                    {% if project.status == 'in_progress' and is_owner %}
                    <div style="margin-top: var(--space-6);">
                        <h4 style="color: var(--accent-primary); margin-bottom: var(--space-3); font-size: var(--text-lg);">‚ûï Ajouter des Collaborateurs</h4>
                        <div style="background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%); padding: var(--space-4); border-radius: var(--radius-lg); margin-bottom: var(--space-4); border: 1px solid rgba(79, 70, 229, 0.2);">
                            <p style="margin: 0; color: var(--accent-primary); font-size: var(--text-sm);">
                                Il reste {{ 10|add:"-"|add:collaborators.count }} place{{ 10|add:"-"|add:collaborators.count|pluralize }} pour des collaborateurs (sur un maximum de 10).
                            </p>
                        </div>
                        
                        {% if collaborators.count < 10 %}
                        <form method="post" action="{% url 'student:add_collaborator' project.id %}" class="add-collaborator-form">
                            {% csrf_token %}
                            <div style="margin-bottom: var(--space-4);">
                                <label for="collaborator" style="display: block; margin-bottom: var(--space-2); font-weight: 600; color: var(--accent-primary);">S√©lectionner un √©tudiant:</label>
                                <select name="collaborator" id="collaborator" class="select2" style="width: 100%" required>
                                    <option value="">Rechercher un √©tudiant...</option>
                                    {% for student in available_students %}
                                        <option value="{{ student.id }}" 
                                                data-department="{{ student.department }}"
                                                data-year="{{ student.year_of_study }}">
                                            {{ student.user.get_full_name|default:student.user.username }}
                                            ({{ student.student_id }}) - {{ student.department }} - {{ student.get_year_of_study_display }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="action-btn primary">üì§ Envoyer l'Invitation</button>
                        </form>
                        {% else %}
                        <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%); color: var(--error); padding: var(--space-4); border-radius: var(--radius-lg); border: 1px solid rgba(239, 68, 68, 0.3);">
                            Vous avez atteint le nombre maximum de collaborateurs (10) pour ce projet.
                        </div>
                        {% endif %}
                    </div>

                    <!-- Pending Invitations -->
                    {% if pending_invitations %}
                    <div class="pending-invitations">
                        <h4 style="margin: 0 0 var(--space-4) 0; color: #856404; font-size: var(--text-lg);">‚è≥ Invitations en Attente ({{ pending_invitations.count }})</h4>
                        {% for invitation in pending_invitations %}
                        <div class="invitation-item">
                            <div>
                                <strong style="color: var(--text-primary);">{{ invitation.recipient.user.get_full_name|default:invitation.recipient.user.username }}</strong>
                                <span style="color: #856404; font-size: var(--text-xs);">({{ invitation.recipient.student_id }})</span>
                                <div style="font-size: var(--text-xs); color: #856404;">Envoy√©e le {{ invitation.created_at|date:"d/m/Y √† H:i" }}</div>
                            </div>
                            <a href="{% url 'student:cancel_invitation' invitation.id %}" 
                               class="action-btn" style="background: var(--text-muted); color: white; padding: var(--space-1) var(--space-2); font-size: var(--text-xs);"
                               onclick="return confirm('Annuler cette invitation?')">
                                üóëÔ∏è Annuler
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Timeline and Milestones -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">üéØ Jalons du Projet</h2>
                    <span style="font-size: var(--text-sm); color: var(--text-muted);">{{ milestones.count }} jalon{{ milestones.count|pluralize }}</span>
                </div>
                <div class="section-body">
                    {% if milestones %}
                        <div class="timeline-container">
                            {% for milestone in milestones %}
                            <div class="milestone-item {% if milestone.completed %}completed{% elif milestone.is_overdue %}overdue{% endif %}">
                                <div class="milestone-marker {% if milestone.completed %}milestone-completed{% elif milestone.is_overdue %}milestone-overdue{% else %}milestone-pending{% endif %}">
                                    {% if milestone.completed %}‚úì{% else %}‚Ä¢{% endif %}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3); gap: var(--space-4);">
                                    <h4 style="margin: 0; color: var(--accent-primary); font-size: var(--text-lg);">
                                        {{ milestone.title }}
                                        {% if milestone.is_overdue and not milestone.completed %}
                                            <span style="background: var(--error); color: white; padding: var(--space-1) var(--space-2); border-radius: var(--radius-md); font-size: var(--text-xs); margin-left: var(--space-2);">EN RETARD</span>
                                        {% endif %}
                                    </h4>
                                    {% if project.status == 'in_progress' %}
                                    <form method="post" action="{% url 'student:toggle_milestone' milestone.id %}" style="margin: 0;">
                                        {% csrf_token %}
                                        {% if milestone.completed %}
                                            <button type="submit" class="action-btn" style="background: var(--text-muted); color: white; padding: var(--space-1) var(--space-2); font-size: var(--text-xs);">
                                                ‚Ü©Ô∏è Marquer Non Compl√©t√©
                                            </button>
                                        {% else %}
                                            <button type="submit" class="action-btn success" style="padding: var(--space-1) var(--space-2); font-size: var(--text-xs);">
                                                ‚úÖ Marquer Compl√©t√©
                                            </button>
                                        {% endif %}
                                    </form>
                                    {% endif %}
                                </div>
                                
                                <div style="color: var(--text-muted); font-size: var(--text-sm); margin-bottom: var(--space-2);">
                                    <strong>√âch√©ance:</strong> {{ milestone.due_date|date:"d/m/Y" }}
                                </div>
                                
                                {% if milestone.description %}
                                <p style="margin: var(--space-2) 0; color: var(--text-secondary);">{{ milestone.description }}</p>
                                {% endif %}

                                {% if milestone.completed %}
                                <div style="margin-top: var(--space-3); padding: var(--space-3); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); border-radius: var(--radius-lg); font-size: var(--text-sm); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3);">
                                    <strong>‚úÖ Compl√©t√©</strong> par {{ milestone.completed_by.get_full_name|default:milestone.completed_by.username }} 
                                    le {{ milestone.completed_at|date:"d/m/Y √† H:i" }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üéØ</div>
                            <h3>Aucun jalon d√©fini</h3>
                            <p>Ajoutez des jalons pour suivre la progression de votre projet.</p>
                            {% if project.status == 'in_progress' %}
                            <a href="{% url 'student:add_milestone' project.id %}" class="action-btn primary">üéØ Ajouter le Premier Jalon</a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Deliverables -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">üìé Livrables</h2>
                    <span style="font-size: var(--text-sm); color: var(--text-muted);">{{ deliverables.count }} livrable{{ deliverables.count|pluralize }}</span>
                </div>
                <div class="section-body">
                    {% if deliverables %}
                        <div class="deliverables-grid">
                            {% for deliverable in deliverables %}
                            <div class="deliverable-card">
                                <div class="deliverable-header">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 var(--space-2) 0; color: var(--accent-primary); font-size: var(--text-lg);">{{ deliverable.name }}</h4>
                                        <div style="font-size: var(--text-sm); color: var(--text-muted);">
                                            <strong>Type:</strong> {{ deliverable.get_file_type_display }}<br>
                                            <strong>Upload√© le:</strong> {{ deliverable.upload_date|date:"d/m/Y H:i" }}
                                        </div>
                                    </div>
                                    <div class="deliverable-icon">üìÑ</div>
                                </div>
                                <div style="margin-top: var(--space-4); display: flex; gap: var(--space-2);">
                                    {% if deliverable.file_type in 'report,presentation' %}
                                        <button class="action-btn primary" style="padding: var(--space-2) var(--space-3); font-size: var(--text-xs);" 
                                                onclick="previewFile('{{ deliverable.file.url }}', '{{ deliverable.file_type }}', '{{ deliverable.name }}')">
                                            üëÅÔ∏è Aper√ßu
                                        </button>
                                    {% endif %}
                                    <a href="{{ deliverable.file.url }}" class="action-btn success" style="padding: var(--space-2) var(--space-3); font-size: var(--text-xs);" target="_blank">
                                        üì• T√©l√©charger
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üìé</div>
                            <h3>Aucun livrable</h3>
                            <p>Uploadez vos documents, rapports et pr√©sentations.</p>
                            {% if project.status == 'in_progress' %}
                            <a href="{% url 'student:upload_deliverable' project.id %}" class="action-btn primary">üìé Ajouter le Premier Livrable</a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Discussion Section -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">üí¨ Discussion du Projet</h2>
                    <span style="font-size: var(--text-sm); color: var(--text-muted);">{{ project.comments.all.count }} commentaire{{ project.comments.all.count|pluralize }}</span>
                </div>
                <div class="section-body">
                    <!-- Comment Form -->
                    {% if is_owner or is_collaborator %}
                    <div style="margin-bottom: var(--space-6);">
                        <form method="post" action="{% url 'student:add_comment' project.id %}">
                            {% csrf_token %}
                            <div style="margin-bottom: var(--space-3);">
                                <textarea name="content" rows="3" placeholder="Ajouter un commentaire sur le projet..." 
                                          style="width: 100%; padding: var(--space-3); border: 2px solid var(--border-primary); border-radius: var(--radius-lg); resize: vertical; font-family: inherit; background: var(--bg-secondary); color: var(--text-primary);" required></textarea>
                            </div>
                            <button type="submit" class="action-btn primary">üí¨ Publier le Commentaire</button>
                        </form>
                    </div>
                    {% endif %}

                    <!-- Comments List -->
                    {% if project.comments.all %}
                    <div class="comment-section">
                        {% for comment in project.comments.all %}
                        <div class="comment-item {% if comment.is_teacher_comment %}comment-teacher{% else %}comment-student{% endif %}">
                            <div class="comment-header">
                                <div class="comment-author">
                                    {% if comment.is_teacher_comment %}
                                        üéì {{ comment.author.get_full_name|default:comment.author.username }} (Enseignant)
                                    {% else %}
                                        üë§ {{ comment.author.get_full_name|default:comment.author.username }}
                                    {% endif %}
                                </div>
                                <div class="comment-date">{{ comment.created_at|date:"d/m/Y H:i" }}</div>
                            </div>
                            <div style="line-height: 1.5; color: var(--text-secondary);">
                                {{ comment.content|linebreaks }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <h3>Aucun commentaire</h3>
                        <p>Commencez la discussion sur ce projet. Partagez vos id√©es et vos questions!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div>
            <!-- Project Information -->
            <div class="sidebar-card">
                <div class="sidebar-header">
                    <h3 style="color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-xl); font-weight: 700;">
                        ‚ÑπÔ∏è Informations du Projet
                    </h3>
                </div>
                <div class="sidebar-body">
                    <table class="info-table">
                        <tr>
                            <th>Type de projet</th>
                            <td>{{ project.get_project_type_display }}</td>
                        </tr>
                        <tr>
                            <th>Date de d√©but</th>
                            <td>{{ project.start_date|date:"d/m/Y" }}</td>
                        </tr>
                        {% if project.end_date %}
                        <tr>
                            <th>Date de fin</th>
                            <td>{{ project.end_date|date:"d/m/Y" }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Propri√©taire</th>
                            <td>{{ project.student.user.get_full_name|default:project.student.user.username }}</td>
                        </tr>
                        <tr>
                            <th>D√©partement</th>
                            <td>{{ project.student.department }}</td>
                        </tr>
                        {% if project.module %}
                        <tr>
                            <th>Module associ√©</th>
                            <td>{{ project.module.code }} - {{ project.module.name }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Project Activity -->
            <div class="sidebar-card">
                <div class="sidebar-header">
                    <h3 style="color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-xl); font-weight: 700;">
                        üìä Activit√© du Projet
                    </h3>
                </div>
                <div class="sidebar-body">
                    {% if project_activities %}
                    <div style="max-height: 300px; overflow-y: auto;">
                        {% for activity in project_activities %}
                        <div style="padding: var(--space-3) 0; border-bottom: 1px solid var(--border-primary);">
                            <div style="font-weight: 600; color: var(--accent-primary); font-size: var(--text-sm);">
                                {{ activity.get_activity_type_display }}
                            </div>
                            <div style="font-size: var(--text-xs); color: var(--text-muted); margin: var(--space-1) 0;">
                                {{ activity.description }}
                            </div>
                            <div style="font-size: var(--text-xs); color: var(--text-muted);">
                                Par {{ activity.user.get_full_name|default:activity.user.username }} ‚Ä¢ {{ activity.created_at|timesince }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state" style="padding: var(--space-6);">
                        <div style="font-size: var(--text-4xl); margin-bottom: var(--space-3); opacity: 0.3;">üìä</div>
                        <p style="font-size: var(--text-sm); margin: 0;">Aucune activit√© enregistr√©e</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="sidebar-card">
                <div class="sidebar-header">
                    <h3 style="color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-xl); font-weight: 700;">
                        üìà Statistiques Rapides
                    </h3>
                </div>
                <div class="sidebar-body">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">{{ milestones.count }}</div>
                            <div class="stat-label">Jalons</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ deliverables.count }}</div>
                            <div class="stat-label">Livrables</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ collaborators.count|add:1 }}</div>
                            <div class="stat-label">Membres</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">{{ project.comments.all.count }}</div>
                            <div class="stat-label">Commentaires</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="previewTitle">Aper√ßu du fichier</h3>
                <button class="close" onclick="closePreview()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="previewContainer">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    $('#collaborator').select2({
        placeholder: "Rechercher par nom, ID √©tudiant, ou d√©partement...",
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return "Aucun √©tudiant disponible";
            },
            searching: function() {
                return "Recherche...";
            }
        }
    });
});

function previewFile(url, fileType, fileName) {
    const modal = document.getElementById('filePreviewModal');
    const container = document.getElementById('previewContainer');
    const title = document.getElementById('previewTitle');

    title.textContent = 'Aper√ßu: ' + fileName;
    container.innerHTML = '';

    if (!url.startsWith('http')) {
        url = window.location.origin + url;
    }

    if (fileType === 'report' || fileType === 'presentation') {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts');

        iframe.onload = function() {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (!iframeDoc || iframeDoc.body.innerHTML === '') {
                    throw new Error('Empty content');
                }
            } catch (e) {
                container.innerHTML = `
                    <div class="preview-error">
                        <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;">üìÑ</div>
                        <p>L'aper√ßu direct n'est pas disponible.</p>
                        <p>Le fichier peut √™tre t√©l√©charg√© et visualis√© localement.</p>
                        <a href="${url}" class="action-btn primary" target="_blank">üì• T√©l√©charger le fichier</a>
                    </div>
                `;
            }
        };

        iframe.onerror = function() {
            container.innerHTML = `
                <div class="preview-error">
                    <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;">‚ùå</div>
                    <p>Impossible de charger l'aper√ßu du fichier.</p>
                    <a href="${url}" class="action-btn primary" target="_blank">üì• T√©l√©charger le fichier</a>
                </div>
            `;
        };

        container.appendChild(iframe);
    } else {
        container.innerHTML = `
            <div class="preview-error">
                <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;">üìÑ</div>
                <p>L'aper√ßu n'est pas disponible pour ce type de fichier.</p>
                <a href="${url}" class="action-btn primary" target="_blank">üì• T√©l√©charger le fichier</a>
            </div>
        `;
    }

    modal.style.display = 'flex';
}

function closePreview() {
    const modal = document.getElementById('filePreviewModal');
    modal.style.display = 'none';
    document.getElementById('previewContainer').innerHTML = '';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('filePreviewModal');
    if (event.target === modal) {
        closePreview();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePreview();
    }
});
</script>
{% endblock %}