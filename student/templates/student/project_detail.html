{% extends 'student/base.html' %}
{% load static %}

{% block title %}{{ project.title }} - DÃ©tails du Projet{% endblock %}

{% block breadcrumb_items %}
<span class="breadcrumb-separator">></span>
<a href="{% url 'student:dashboard' %}">Projets</a>
<span class="breadcrumb-separator">></span>
<span>{{ project.title|truncatewords:3 }}</span>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'student/css/project_detail.css' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .project-workspace {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
    }
    
    .project-main-header {
        background: linear-gradient(135deg, #3a6ea5 0%, #2c5aa0 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
        grid-column: 1 / -1;
    }
    
    .project-main-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50px;
        width: 150px;
        height: 200%;
        background: rgba(255,255,255,0.1);
        transform: rotate(15deg);
    }
    
    .project-title-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    
    .project-main-title {
        margin: 0 0 15px 0;
        font-size: 2.2em;
    }
    
    .project-meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .meta-card {
        background: rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 8px;
        backdrop-filter: blur(10px);
    }
    
    .meta-label {
        font-size: 0.9em;
        opacity: 0.8;
        margin-bottom: 5px;
    }
    
    .meta-value {
        font-weight: bold;
        font-size: 1.1em;
    }
    
    .actions-panel {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border-left: 4px solid #3a6ea5;
    }
    
    .actions-grid {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
    }
    
    .action-btn {
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .action-btn.primary {
        background: #3a6ea5;
        color: white;
    }
    
    .action-btn.primary:hover {
        background: #2c5aa0;
        transform: translateY(-1px);
    }
    
    .action-btn.success {
        background: #28a745;
        color: white;
    }
    
    .action-btn.success:hover {
        background: #1e7e34;
        transform: translateY(-1px);
    }
    
    .action-btn.danger {
        background: #dc3545;
        color: white;
    }
    
    .action-btn.danger:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
    
    .action-btn.warning {
        background: #ffc107;
        color: #212529;
    }
    
    .action-btn.warning:hover {
        background: #e0a800;
        transform: translateY(-1px);
    }
    
    .section-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-left: 4px solid #3a6ea5;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f3f4;
    }
    
    .section-title {
        color: #3a6ea5;
        font-size: 1.3em;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .sidebar-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-left: 4px solid #3a6ea5;
    }
    
    .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .info-table th,
    .info-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .info-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #3a6ea5;
        width: 40%;
    }
    
    .collaborators-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .collaborator-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #3a6ea5;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
    }
    
    .collaborator-card:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }
    
    .collaborator-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #3a6ea5;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2em;
    }
    
    .timeline-container {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline-container::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }
    
    .milestone-item {
        position: relative;
        margin-bottom: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3a6ea5;
    }
    
    .milestone-marker {
        position: absolute;
        left: -22px;
        top: 25px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8em;
        font-weight: bold;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .milestone-completed {
        background: #28a745;
        color: white;
    }
    
    .milestone-pending {
        background: #6c757d;
        color: white;
    }
    
    .milestone-overdue {
        background: #dc3545;
        color: white;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    
    .deliverables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }
    
    .deliverable-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .deliverable-card:hover {
        border-color: #3a6ea5;
        background: #e8f4ff;
        transform: translateY(-2px);
    }
    
    .deliverable-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    
    .deliverable-icon {
        font-size: 2.5em;
        opacity: 0.3;
    }
    
    .add-collaborator-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #e9ecef;
    }
    
    .pending-invitations {
        background: #fff3cd;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #ffc107;
    }
    
    .invitation-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .invitation-item:last-child {
        border-bottom: none;
    }
    
    .comment-section {
        max-height: 500px;
        overflow-y: auto;
        margin-top: 15px;
    }
    
    .comment-item {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        border-left: 4px solid #3a6ea5;
    }
    
    .comment-student {
        background: #f8f9fa;
        border-left-color: #3a6ea5;
    }
    
    .comment-teacher {
        background: #e8f4ff;
        border-left-color: #007bff;
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .comment-author {
        font-weight: bold;
        color: #3a6ea5;
    }
    
    .comment-date {
        font-size: 0.9em;
        color: #6c757d;
    }
    
    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background-color: white;
        width: 90%;
        max-width: 1000px;
        height: 90%;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 12px 12px 0 0;
    }
    
    .modal-header h3 {
        margin: 0;
        color: #3a6ea5;
    }
    
    .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
        transition: color 0.3s ease;
    }
    
    .close:hover {
        color: #3a6ea5;
    }
    
    .modal-body {
        flex: 1;
        padding: 20px;
        overflow: auto;
    }
    
    .preview-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: #6c757d;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-in_progress {
        background: #17a2b8;
        color: white;
    }
    
    .status-submitted {
        background: #ffc107;
        color: #212529;
    }
    
    .status-validated {
        background: #28a745;
        color: white;
    }
    
    .status-rejected {
        background: #dc3545;
        color: white;
    }
    
    .status-draft {
        background: #6c757d;
        color: white;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-bar {
        height: 100%;
        transition: width 0.3s ease;
        border-radius: 4px;
    }
    
    .progress-draft {
        width: 25%;
        background: #6c757d;
    }
    
    .progress-in_progress {
        width: 50%;
        background: #17a2b8;
    }
    
    .progress-submitted {
        width: 75%;
        background: #ffc107;
    }
    
    .progress-validated {
        width: 100%;
        background: #28a745;
    }
    
    .progress-rejected {
        width: 25%;
        background: #dc3545;
    }

    @media (max-width: 768px) {
        .project-workspace {
            grid-template-columns: 1fr;
        }
        
        .project-main-header {
            padding: 20px;
        }
        
        .project-main-title {
            font-size: 1.8em;
        }
        
        .project-meta-grid {
            grid-template-columns: 1fr;
        }
        
        .actions-grid {
            flex-direction: column;
        }
        
        .action-btn {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="project-workspace">
        <!-- Project Main Header -->
        <div class="project-main-header">
            <div class="project-title-section">
                <div style="flex: 1;">
                    <h1 class="project-main-title">{{ project.title }}</h1>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <span class="status-badge status-{{ project.status|lower }}">
                            {{ project.get_status_display }}
                        </span>
                        {% if project.module %}
                        <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px;">
                            ð {{ project.module.code }}
                        </span>
                        {% endif %}
                        {% if is_owner %}
                        <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px;">
                            ð PropriÃ©taire
                        </span>
                        {% elif is_collaborator %}
                        <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px;">
                            ð¤ Collaborateur
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-size: 0.9em; opacity: 0.9;">Progression du Projet</span>
                            <span style="font-size: 0.9em; opacity: 0.9;">
                                {% if project.status == 'draft' %}25%
                                {% elif project.status == 'in_progress' %}50%
                                {% elif project.status == 'submitted' %}75%
                                {% elif project.status == 'validated' %}100%
                                {% elif project.status == 'rejected' %}25%
                                {% endif %}
                            </span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar progress-{{ project.status|lower }}"></div>
                        </div>
                    </div>
                    
                    <div class="project-meta-grid">
                        <div class="meta-card">
                            <div class="meta-label">ð¤ PropriÃ©taire</div>
                            <div class="meta-value">{{ project.student.user.get_full_name|default:project.student.user.username }}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">ð Type de Projet</div>
                            <div class="meta-value">{{ project.get_project_type_display }}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">ð Date de CrÃ©ation</div>
                            <div class="meta-value">{{ project.created_at|date:"d/m/Y" }}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">â° DerniÃ¨re MAJ</div>
                            <div class="meta-value">{{ project.updated_at|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                </div>
                <div style="font-size: 4em; opacity: 0.2;">ð</div>
            </div>
        </div>

        <!-- Main Content -->
        <div>
            <!-- Actions Panel -->
            <div class="actions-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #3a6ea5;">â¡ Actions Disponibles</h3>
                    <span style="font-size: 0.9em; color: #6c757d;">GÃ©rez votre projet</span>
                </div>
                <div class="actions-grid">
                    {% if project.status == 'in_progress' %}
                        {% if is_owner %}
                            <a href="{% url 'student:project_edit' project.id %}" class="action-btn primary">
                                âï¸ Modifier le Projet
                            </a>
                            <a href="{% url 'student:project_delete' project.id %}" class="action-btn danger">
                                ðï¸ Supprimer le Projet
                            </a>
                            <form method="post" action="{% url 'student:project_submit' project.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="action-btn success" onclick="return confirm('Ãtes-vous sÃ»r de vouloir soumettre ce projet? Vous ne pourrez plus le modifier aprÃ¨s soumission.')">
                                    ð Soumettre pour Validation
                                </button>
                            </form>
                        {% endif %}
                        <a href="{% url 'student:add_milestone' project.id %}" class="action-btn primary">
                            ð¯ Ajouter un Jalon
                        </a>
                        <a href="{% url 'student:upload_deliverable' project.id %}" class="action-btn primary">
                            ð Uploader un Livrable
                        </a>
                    {% elif project.status == 'rejected' and is_owner %}
                        <form method="post" action="{% url 'student:project_change_status' project.id 'in_progress' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn warning">
                                ð Reprendre les Modifications
                            </button>
                        </form>
                    {% endif %}

                    {% if user.is_staff and project.status == 'submitted' %}
                        <form method="post" action="{% url 'student:project_approve' project.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn success">â Valider</button>
                        </form>
                        <form method="post" action="{% url 'student:project_reject' project.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn danger">â Rejeter</button>
                        </form>
                    {% endif %}
                </div>
            </div>

            <!-- Project Description -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ð Description du Projet</h2>
                </div>
                <div style="line-height: 1.6; color: #333;">
                    {{ project.description|linebreaks }}
                </div>
                
               
                
                {% if project.module_or_company %}
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                    <strong style="color: #3a6ea5;">ð¢ Module/Entreprise:</strong> {{ project.module_or_company }}
                </div>
                {% endif %}
            </div>

            <!-- Collaborators -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ð¥ Ãquipe de Projet</h2>
                    <span style="font-size: 0.9em; color: #6c757d;">{{ collaborators.count|add:1 }} membre{{ collaborators.count|add:1|pluralize }}</span>
                </div>
                
                <!-- Project Owner -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #3a6ea5; margin-bottom: 10px;">ð PropriÃ©taire du Projet</h4>
                    <div class="collaborator-card" style="border-left-color: #ffc107;">
                        <div class="collaborator-avatar" style="background: #ffc107;">
                            {{ project.student.user.first_name|first|default:project.student.user.username|first|upper }}
                        </div>
                        <div style="flex: 1;">
                            <strong>{{ project.student.user.get_full_name|default:project.student.user.username }}</strong><br>
                            <small style="color: #6c757d;">{{ project.student.student_id }} â¢ {{ project.student.department }}</small>
                        </div>
                        <div style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">
                            PROPRIÃTAIRE
                        </div>
                    </div>
                </div>

                <!-- Collaborators -->
                {% if collaborators %}
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #3a6ea5; margin-bottom: 10px;">ð¤ Collaborateurs ({{ collaborators.count }})</h4>
                    <div class="collaborators-grid">
                        {% for collaborator in collaborators %}
                        <div class="collaborator-card">
                            <div class="collaborator-avatar">
                                {{ collaborator.user.first_name|first|default:collaborator.user.username|first|upper }}
                            </div>
                            <div style="flex: 1;">
                                <strong>{{ collaborator.user.get_full_name|default:collaborator.user.username }}</strong><br>
                                <small style="color: #6c757d;">{{ collaborator.student_id }} â¢ {{ collaborator.department }}</small>
                            </div>
                            {% if is_owner and project.status == 'in_progress' %}
                            <a href="{% url 'student:remove_collaborator' project.id collaborator.id %}" 
                               class="action-btn danger" style="padding: 4px 8px; font-size: 0.8em;"
                               onclick="return confirm('Retirer {{ collaborator.user.get_full_name|default:collaborator.user.username }} du projet?')">
                                ðï¸
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Add Collaborators (Owner Only) -->
                {% if project.status == 'in_progress' and is_owner %}
                <div style="margin-top: 20px;">
                    <h4 style="color: #3a6ea5; margin-bottom: 10px;">â Ajouter des Collaborateurs</h4>
                    <div style="background: #e8f4ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #b3d9ff;">
                        <p style="margin: 0; color: #3a6ea5; font-size: 0.9em;">
                            Il reste {{ 10|add:"-"|add:collaborators.count }} place{{ 10|add:"-"|add:collaborators.count|pluralize }} pour des collaborateurs (sur un maximum de 10).
                        </p>
                    </div>
                    
                    {% if collaborators.count < 10 %}
                    <form method="post" action="{% url 'student:add_collaborator' project.id %}" class="add-collaborator-form">
                        {% csrf_token %}
                        <div style="margin-bottom: 15px;">
                            <label for="collaborator" style="display: block; margin-bottom: 5px; font-weight: 500; color: #3a6ea5;">SÃ©lectionner un Ã©tudiant:</label>
                            <select name="collaborator" id="collaborator" class="select2" style="width: 100%" required>
                                <option value="">Rechercher un Ã©tudiant...</option>
                                {% for student in available_students %}
                                    <option value="{{ student.id }}" 
                                            data-department="{{ student.department }}"
                                            data-year="{{ student.year_of_study }}">
                                        {{ student.user.get_full_name|default:student.user.username }}
                                        ({{ student.student_id }}) - {{ student.department }} - {{ student.get_year_of_study_display }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="action-btn primary">ð¤ Envoyer l'Invitation</button>
                    </form>
                    {% else %}
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        Vous avez atteint le nombre maximum de collaborateurs (10) pour ce projet.
                    </div>
                    {% endif %}
                </div>

                <!-- Pending Invitations -->
                {% if pending_invitations %}
                <div class="pending-invitations">
                    <h4 style="margin: 0 0 15px 0; color: #856404;">â³ Invitations en Attente ({{ pending_invitations.count }})</h4>
                    {% for invitation in pending_invitations %}
                    <div class="invitation-item">
                        <div>
                            <strong>{{ invitation.recipient.user.get_full_name|default:invitation.recipient.user.username }}</strong>
                            <span style="color: #856404; font-size: 0.8em;">({{ invitation.recipient.student_id }})</span>
                            <div style="font-size: 0.8em; color: #856404;">EnvoyÃ©e le {{ invitation.created_at|date:"d/m/Y Ã  H:i" }}</div>
                        </div>
                        <a href="{% url 'student:cancel_invitation' invitation.id %}" 
                           class="action-btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.8em;"
                           onclick="return confirm('Annuler cette invitation?')">
                            ðï¸ Annuler
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endif %}
            </div>

            <!-- Timeline and Milestones -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ð¯ Jalons du Projet</h2>
                    <span style="font-size: 0.9em; color: #6c757d;">{{ milestones.count }} jalon{{ milestones.count|pluralize }}</span>
                </div>
                
                {% if milestones %}
                    <div class="timeline-container">
                        {% for milestone in milestones %}
                        <div class="milestone-item {% if milestone.completed %}completed{% elif milestone.is_overdue %}overdue{% endif %}">
                            <div class="milestone-marker {% if milestone.completed %}milestone-completed{% elif milestone.is_overdue %}milestone-overdue{% else %}milestone-pending{% endif %}">
                                {% if milestone.completed %}â{% else %}â¢{% endif %}
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #3a6ea5;">
                                    {{ milestone.title }}
                                    {% if milestone.is_overdue and not milestone.completed %}
                                        <span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; margin-left: 8px;">EN RETARD</span>
                                    {% endif %}
                                </h4>
                                {% if project.status == 'in_progress' %}
                                <form method="post" action="{% url 'student:toggle_milestone' milestone.id %}" style="margin: 0;">
                                    {% csrf_token %}
                                    {% if milestone.completed %}
                                        <button type="submit" class="action-btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.8em;">
                                            â©ï¸ Marquer Non ComplÃ©tÃ©
                                        </button>
                                    {% else %}
                                        <button type="submit" class="action-btn success" style="padding: 4px 8px; font-size: 0.8em;">
                                            â Marquer ComplÃ©tÃ©
                                        </button>
                                    {% endif %}
                                </form>
                                {% endif %}
                            </div>
                            
                            <div style="color: #6c757d; font-size: 0.9em; margin-bottom: 8px;">
                                <strong>ÃchÃ©ance:</strong> {{ milestone.due_date|date:"d/m/Y" }}
                            </div>
                            
                            {% if milestone.description %}
                            <p style="margin: 8px 0; color: #333;">{{ milestone.description }}</p>
                            {% endif %}

                            {% if milestone.completed %}
                            <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; font-size: 0.9em; color: #155724;">
                                <strong>â ComplÃ©tÃ©</strong> par {{ milestone.completed_by.get_full_name|default:milestone.completed_by.username }} 
                                le {{ milestone.completed_at|date:"d/m/Y Ã  H:i" }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;">ð¯</div>
                        <h3>Aucun jalon dÃ©fini</h3>
                        <p>Ajoutez des jalons pour suivre la progression de votre projet.</p>
                        {% if project.status == 'in_progress' %}
                        <a href="{% url 'student:add_milestone' project.id %}" class="action-btn primary">ð¯ Ajouter le Premier Jalon</a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Deliverables -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ð Livrables</h2>
                    <span style="font-size: 0.9em; color: #6c757d;">{{ deliverables.count }} livrable{{ deliverables.count|pluralize }}</span>
                </div>
                
                {% if deliverables %}
                    <div class="deliverables-grid">
                        {% for deliverable in deliverables %}
                        <div class="deliverable-card">
                            <div class="deliverable-header">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 8px 0; color: #3a6ea5;">{{ deliverable.name }}</h4>
                                    <div style="font-size: 0.9em; color: #6c757d;">
                                        <strong>Type:</strong> {{ deliverable.get_file_type_display }}<br>
                                        <strong>UploadÃ© le:</strong> {{ deliverable.upload_date|date:"d/m/Y H:i" }}
                                    </div>
                                </div>
                                <div class="deliverable-icon">ð</div>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 8px;">
                                {% if deliverable.file_type in 'report,presentation' %}
                                    <button class="action-btn primary" style="padding: 6px 12px; font-size: 0.8em;" 
                                            onclick="previewFile('{{ deliverable.file.url }}', '{{ deliverable.file_type }}', '{{ deliverable.name }}')">
                                        ðï¸ AperÃ§u
                                    </button>
                                {% endif %}
                                <a href="{{ deliverable.file.url }}" class="action-btn" style="background: #28a745; color: white; padding: 6px 12px; font-size: 0.8em;" target="_blank">
                                    ð¥ TÃ©lÃ©charger
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;">ð</div>
                        <h3>Aucun livrable</h3>
                        <p>Uploadez vos documents, rapports et prÃ©sentations.</p>
                        {% if project.status == 'in_progress' %}
                        <a href="{% url 'student:upload_deliverable' project.id %}" class="action-btn primary">ð Ajouter le Premier Livrable</a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Discussion Section -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ð¬ Discussion du Projet</h2>
                    <span style="font-size: 0.9em; color: #6c757d;">{{ project.comments.all.count }} commentaire{{ project.comments.all.count|pluralize }}</span>
                </div>

                <!-- Comment Form -->
                {% if is_owner or is_collaborator %}
                <div style="margin-bottom: 20px;">
                    <form method="post" action="{% url 'student:add_comment' project.id %}">
                        {% csrf_token %}
                        <div style="margin-bottom: 10px;">
                            <textarea name="content" rows="3" placeholder="Ajouter un commentaire sur le projet..." 
                                      style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; resize: vertical;" required></textarea>
                        </div>
                        <button type="submit" class="action-btn primary">ð¬ Publier le Commentaire</button>
                    </form>
                </div>
                {% endif %}

                <!-- Comments List -->
                {% if project.comments.all %}
                <div class="comment-section">
                    {% for comment in project.comments.all %}
                    <div class="comment-item {% if 'FEEDBACK ENSEIGNANT' in comment.content %}comment-teacher{% else %}comment-student{% endif %}">
                        <div class="comment-header">
                            <div class="comment-author">
                                {% if 'FEEDBACK ENSEIGNANT' in comment.content %}
                                    ð {{ comment.author.user.get_full_name|default:comment.author.user.username }} (Enseignant)
                                {% else %}
                                    ð¤ {{ comment.author.user.get_full_name|default:comment.author.user.username }}
                                {% endif %}
                            </div>
                            <div class="comment-date">{{ comment.created_at|date:"d/m/Y H:i" }}</div>
                        </div>
                        <div style="line-height: 1.5; color: #333;">
                            {{ comment.content|linebreaks }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;">ð¬</div>
                    <h3>Aucun commentaire</h3>
                    <p>Commencez la discussion sur ce projet. Partagez vos idÃ©es et vos questions!</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div>
            <!-- Project Information -->
            <div class="sidebar-card">
                <h3 style="color: #3a6ea5; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    â¹ï¸ Informations du Projet
                </h3>
                <table class="info-table">
                    <tr>
                        <th>Type de projet</th>
                        <td>{{ project.get_project_type_display }}</td>
                    </tr>
                    <tr>
                        <th>Date de dÃ©but</th>
                        <td>{{ project.start_date|date:"d/m/Y" }}</td>
                    </tr>
                    {% if project.end_date %}
                    <tr>
                        <th>Date de fin</th>
                        <td>{{ project.end_date|date:"d/m/Y" }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>PropriÃ©taire</th>
                        <td>{{ project.student.user.get_full_name|default:project.student.user.username }}</td>
                    </tr>
                    <tr>
                        <th>DÃ©partement</th>
                        <td>{{ project.student.department }}</td>
                    </tr>
                    {% if project.module %}
                    <tr>
                        <th>Module associÃ©</th>
                        <td>{{ project.module.code }} - {{ project.module.name }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>

            <!-- Project Activity -->
            <div class="sidebar-card">
                <h3 style="color: #3a6ea5; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    ð ActivitÃ© du Projet
                </h3>
                {% if project_activities %}
                <div style="max-height: 300px; overflow-y: auto;">
                    {% for activity in project_activities %}
                    <div style="padding: 10px 0; border-bottom: 1px solid #f1f3f4;">
                        <div style="font-weight: 500; color: #3a6ea5; font-size: 0.9em;">
                            {{ activity.get_activity_type_display }}
                        </div>
                        <div style="font-size: 0.85em; color: #6c757d; margin: 4px 0;">
                            {{ activity.description }}
                        </div>
                        <div style="font-size: 0.8em; color: #6c757d;">
                            Par {{ activity.user.get_full_name|default:activity.user.username }} â¢ {{ activity.created_at|timesince }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 20px;">
                    <div style="font-size: 2em; margin-bottom: 10px; opacity: 0.3;">ð</div>
                    <p style="font-size: 0.9em;">Aucune activitÃ© enregistrÃ©e</p>
                </div>
                {% endif %}
            </div>

            <!-- Quick Stats -->
            <div class="sidebar-card">
                <h3 style="color: #3a6ea5; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    ð Statistiques Rapides
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #3a6ea5;">{{ milestones.count }}</div>
                        <div style="font-size: 0.8em; color: #6c757d;">Jalons</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #3a6ea5;">{{ deliverables.count }}</div>
                        <div style="font-size: 0.8em; color: #6c757d;">Livrables</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #3a6ea5;">{{ collaborators.count|add:1 }}</div>
                        <div style="font-size: 0.8em; color: #6c757d;">Membres</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #3a6ea5;">{{ project.comments.all.count }}</div>
                        <div style="font-size: 0.8em; color: #6c757d;">Commentaires</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="previewTitle">AperÃ§u du fichier</h3>
                <span class="close" onclick="closePreview()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="previewContainer">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    $('#collaborator').select2({
        placeholder: "Rechercher par nom, ID Ã©tudiant, ou dÃ©partement...",
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return "Aucun Ã©tudiant disponible";
            },
            searching: function() {
                return "Recherche...";
            }
        }
    });
});

function previewFile(url, fileType, fileName) {
    const modal = document.getElementById('filePreviewModal');
    const container = document.getElementById('previewContainer');
    const title = document.getElementById('previewTitle');

    title.textContent = 'AperÃ§u: ' + fileName;
    container.innerHTML = '';

    if (!url.startsWith('http')) {
        url = window.location.origin + url;
    }

    if (fileType === 'report' || fileType === 'presentation') {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts');

        iframe.onload = function() {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (!iframeDoc || iframeDoc.body.innerHTML === '') {
                    throw new Error('Empty content');
                }
            } catch (e) {
                container.innerHTML = `
                    <div class="preview-error">
                        <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;">ð</div>
                        <p>L'aperÃ§u direct n'est pas disponible.</p>
                        <p>Le fichier peut Ãªtre tÃ©lÃ©chargÃ© et visualisÃ© localement.</p>
                        <a href="${url}" class="action-btn primary" target="_blank">ð¥ TÃ©lÃ©charger le fichier</a>
                    </div>
                `;
            }
        };

        iframe.onerror = function() {
            container.innerHTML = `
                <div class="preview-error">
                    <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;">â</div>
                    <p>Impossible de charger l'aperÃ§u du fichier.</p>
                    <a href="${url}" class="action-btn primary" target="_blank">ð¥ TÃ©lÃ©charger le fichier</a>
                </div>
            `;
        };

        container.appendChild(iframe);
    } else {
        container.innerHTML = `
            <div class="preview-error">
                <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;">ð</div>
                <p>L'aperÃ§u n'est pas disponible pour ce type de fichier.</p>
                <a href="${url}" class="action-btn primary" target="_blank">ð¥ TÃ©lÃ©charger le fichier</a>
            </div>
        `;
    }

    modal.style.display = 'flex';
}

function closePreview() {
    const modal = document.getElementById('filePreviewModal');
    modal.style.display = 'none';
    document.getElementById('previewContainer').innerHTML = '';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('filePreviewModal');
    if (event.target === modal) {
        closePreview();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePreview();
    }
});
</script>
{% endblock %}